generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USERS & AUTH
// ==========================================

model RallyUser {
  id                 String   @id @default(cuid())
  email              String   @unique
  password           String
  name               String
  handle             String   @unique
  role               RallyRole @default(USER)

  // School / Property association
  schoolId           String?
  propertyId         String?
  propertyLeague     String?

  // Fan preferences
  favoriteSchool     String?
  favoriteTeams      Json?     // Array of { propertyId, league }
  favoriteSports     String[]
  supportingSchools  String[]

  // Verification & preferences
  emailVerified      Boolean  @default(false)
  emailUpdates       Boolean  @default(true)
  pushNotifications  Boolean  @default(true)
  acceptedTerms      Boolean  @default(false)

  // Demographics
  userType           String?   // 'student', 'alumni', 'general_fan'
  birthYear          Int?
  residingCity       String?
  residingState      String?

  // Teammate
  teammatePermissions Json?
  invitedBy          String?

  // Engagement
  points             Int      @default(0)
  tier               String   @default("Bronze")

  // Handle moderation
  handleWarnings     Int      @default(0)    // 0-2 warnings before forced rename
  handleLockedUntil  DateTime?               // if set, handle cannot be changed until this time
  handleAutoAssigned Boolean  @default(false) // true if handle was force-assigned after violations

  // Relations
  pointsHistory      PointsEntry[]
  notifications      Notification[] @relation("CreatedNotifications")
  bonusOffers        BonusOffer[]   @relation("CreatedBonusOffers")
  analyticsEvents    AnalyticsEvent[]

  // Social Identity relations
  fanProfile         FanProfile?
  lobbyPresences     LobbyPresence[]
  lobbyReactions     LobbyReaction[]
  crewMemberships    CrewMember[]
  milestones         FanMilestone[]
  shareCards         ShareCard[]

  lastLogin          DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([email])
  @@index([handle])
  @@index([schoolId])
  @@index([role])
  @@index([points])
  @@index([handleWarnings])
}

enum RallyRole {
  USER
  TEAMMATE
  ADMIN
  DEVELOPER
}

// ==========================================
// SCHOOLS & PROPERTIES
// ==========================================

model School {
  id             String   @id @default(cuid())
  name           String
  mascot         String
  conference     String
  primaryColor   String
  secondaryColor String

  // Relations
  events         Event[]
  rewards        Reward[]
  bonusOffers    BonusOffer[]

  createdAt      DateTime @default(now())

  @@index([conference])
}

// ==========================================
// EVENTS
// ==========================================

model Event {
  id             String      @id @default(cuid())
  title          String
  sport          String?
  homeSchoolId   String
  homeTeam       String?
  awaySchoolId   String?
  awayTeam       String?
  venue          String?
  city           String?
  dateTime       DateTime
  status         EventStatus @default(UPCOMING)

  // Relations
  homeSchool     School      @relation(fields: [homeSchoolId], references: [id])
  activations    EventActivation[]
  pointsEntries  PointsEntry[]

  createdBy      String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([homeSchoolId])
  @@index([status])
  @@index([dateTime])
}

enum EventStatus {
  UPCOMING
  LIVE
  COMPLETED
}

model EventActivation {
  id          String @id @default(cuid())
  eventId     String
  type        String // checkin, trivia, prediction, noise_meter, photo, poll, custom
  name        String
  points      Int
  description String

  event       Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

// ==========================================
// POINTS
// ==========================================

model PointsEntry {
  id             String   @id @default(cuid())
  userId         String
  eventId        String?
  activationId   String?
  activationName String
  points         Int
  schoolId       String?
  timestamp      DateTime @default(now())

  user           RallyUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  event          Event?    @relation(fields: [eventId], references: [id])

  @@index([userId])
  @@index([eventId])
  @@index([timestamp])
}

// ==========================================
// REWARDS
// ==========================================

model Reward {
  id          String  @id @default(cuid())
  schoolId    String
  name        String
  pointsCost  Int
  description String?

  school      School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@index([schoolId])
}

// ==========================================
// NOTIFICATIONS
// ==========================================

model Notification {
  id              String              @id @default(cuid())
  title           String
  body            String
  schoolId        String
  targetAudience  String              @default("all") // all, tier_gold, tier_platinum, event_attendees
  status          NotificationStatus  @default(DRAFT)
  scheduledFor    DateTime?
  sentAt          DateTime?
  createdBy       String

  creator         RallyUser @relation("CreatedNotifications", fields: [createdBy], references: [id])

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([schoolId])
  @@index([status])
}

enum NotificationStatus {
  DRAFT
  SCHEDULED
  SENT
}

// ==========================================
// BONUS OFFERS
// ==========================================

model BonusOffer {
  id              String   @id @default(cuid())
  schoolId        String
  name            String
  description     String?
  bonusMultiplier Float?
  bonusPoints     Int?
  activationType  String?  // checkin, trivia, etc. or null for all
  startsAt        DateTime @default(now())
  expiresAt       DateTime
  isActive        Boolean  @default(true)
  createdBy       String

  school          School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  creator         RallyUser @relation("CreatedBonusOffers", fields: [createdBy], references: [id])

  createdAt       DateTime  @default(now())

  @@index([schoolId])
  @@index([isActive])
}

// ==========================================
// TEAMMATE INVITATIONS
// ==========================================

model TeammateInvitation {
  id             String   @id @default(cuid())
  email          String
  name           String?
  propertyId     String?
  propertyLeague String?
  permissions    Json     // TeammatePermissions object
  invitedBy      String
  invitedByName  String?
  status         String   @default("pending") // pending, accepted
  expiresAt      DateTime
  acceptedAt     DateTime?
  userId         String?

  createdAt      DateTime @default(now())

  @@index([email])
  @@index([status])
}

// ==========================================
// ANALYTICS
// ==========================================

model AnalyticsEvent {
  id        String   @id @default(cuid())
  userId    String?
  event     String
  page      String?
  metadata  Json?
  timestamp DateTime @default(now())

  user      RallyUser? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([event])
  @@index([timestamp])
}

// ==========================================
// AFFILIATE OFFERS (Monetization)
// ==========================================

model AffiliateOffer {
  id              String   @id @default(cuid())
  brand           String                        // e.g. "Fanatics", "SeatGeek"
  title           String                        // "20% Off Team Gear"
  description     String?
  category        AffiliateCategory
  affiliateUrl    String                        // Click-through URL with affiliate tag
  imageUrl        String?                       // Brand logo or promo image
  pointsCost      Int      @default(0)          // 0 = free click-through, >0 = points redemption
  commissionType  String?                       // "CPA", "CPC", "rev_share"
  commissionValue String?                       // "8%", "$5 per signup", etc. (internal note)
  sport           String?                       // null = all sports, or "Baseball", "Basketball", etc.
  priority        Int      @default(0)          // Higher = shown first
  isActive        Boolean  @default(true)
  clickCount      Int      @default(0)
  redeemCount     Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isActive])
  @@index([category])
  @@index([priority])
}

enum AffiliateCategory {
  MERCHANDISE       // Fanatics, team stores
  TICKETS           // SeatGeek, StubHub, Vivid Seats
  BETTING           // DraftKings, FanDuel
  STREAMING         // ESPN+, Peacock, Prime Video
  FOOD_DELIVERY     // Uber Eats, DoorDash (gameday ordering)
  SPORTS_EQUIPMENT  // Nike, Under Armour, Dick's
  TRAVEL            // Hotels.com, Airbnb (away game travel)
  OTHER
}

// ==========================================
// MONETIZATION SETTINGS (Developer-managed)
// ==========================================

model MonetizationSettings {
  id                        String   @id @default("global")

  // Affiliate Offers
  affiliatesEnabled         Boolean  @default(true)
  affiliateMaxPerPage       Int      @default(6)

  // AdMob / Ads
  admobEnabled              Boolean  @default(false)
  admobBannerId             String?  // ca-app-pub-XXXX/YYYY
  admobInterstitialId       String?
  admobRewardedVideoId      String?
  admobBannerEnabled        Boolean  @default(false)
  admobInterstitialEnabled  Boolean  @default(false)
  admobRewardedVideoEnabled Boolean  @default(true)
  admobRewardedPoints       Int      @default(50)   // Points per rewarded video

  // Revenue tracking (internal)
  totalAffiliateClicks      Int      @default(0)
  totalAffiliateRedemptions Int      @default(0)
  totalAdImpressions        Int      @default(0)

  updatedAt                 DateTime @updatedAt
}

// ==========================================
// CONTENT FEED
// ==========================================

model ContentItem {
  id        String   @id @default(cuid())
  type      String   // article, update, highlight
  title     String
  body      String?  @db.Text
  imageUrl  String?
  author    String?
  createdAt DateTime @default(now())

  @@index([type])
}

// ==========================================
// SOCIAL IDENTITY ‚Äî Fan Profile
// ==========================================

model FanProfile {
  id                   String   @id @default(cuid())
  userId               String   @unique
  user                 RallyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Computed stats (refreshed periodically or on action)
  totalCheckins        Int      @default(0)
  totalPredictions     Int      @default(0)
  correctPredictions   Int      @default(0)
  totalTrivia          Int      @default(0)
  correctTrivia        Int      @default(0)
  totalPhotos          Int      @default(0)
  totalPolls           Int      @default(0)
  totalNoiseMeter      Int      @default(0)
  eventsAttended       Int      @default(0)
  uniqueVenues         Int      @default(0)

  // Streaks
  currentStreak        Int      @default(0)   // consecutive events attended
  longestStreak        Int      @default(0)
  lastCheckinDate      DateTime?

  // Sports breakdown (JSON: { "Basketball": 12, "Football": 8, ... })
  sportBreakdown       Json?

  // Verified fandom level
  verifiedLevel        VerifiedFanLevel @default(ROOKIE)

  // Profile visibility
  isPublic             Boolean  @default(true)
  profileSlug          String?  @unique        // vanity URL: rally.com/fan/slugname

  // Bio / tagline
  tagline              String?                  // "Die-hard Celtics fan since '08"

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([verifiedLevel])
}

enum VerifiedFanLevel {
  ROOKIE      // Just joined
  CASUAL      // 5+ events
  DEDICATED   // 25+ events
  SUPERFAN    // 100+ events, high accuracy
  LEGEND      // 250+ events, top-tier engagement
}

// ==========================================
// SOCIAL IDENTITY ‚Äî Game Lobby
// ==========================================

model GameLobby {
  id          String   @id @default(cuid())
  eventId     String   @unique
  isActive    Boolean  @default(true)

  // Aggregate counts (denormalized for fast reads)
  fanCount    Int      @default(0)
  reactionCount Int    @default(0)

  presences   LobbyPresence[]
  reactions   LobbyReaction[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
}

model LobbyPresence {
  id          String   @id @default(cuid())
  lobbyId     String
  userId      String
  lobby       GameLobby @relation(fields: [lobbyId], references: [id], onDelete: Cascade)
  user        RallyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  checkedInAt DateTime @default(now())
  isActive    Boolean  @default(true)

  @@unique([lobbyId, userId])
  @@index([lobbyId])
  @@index([userId])
}

model LobbyReaction {
  id          String   @id @default(cuid())
  lobbyId     String
  userId      String
  lobby       GameLobby @relation(fields: [lobbyId], references: [id], onDelete: Cascade)
  user        RallyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        LobbyReactionType
  createdAt   DateTime @default(now())

  @@index([lobbyId])
  @@index([userId])
}

enum LobbyReactionType {
  FIRE        // hype moment
  CLAP        // great play
  CRY         // heartbreaker
  HORN        // let's go / rally
  WAVE        // the wave
  HUNDRED     // perfect / clutch
}

// ==========================================
// SOCIAL IDENTITY ‚Äî Crews (Fan Groups)
// ==========================================

model Crew {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  description     String?
  schoolId        String?              // primary team affiliation
  sport           String?              // primary sport

  // Branding
  avatarEmoji     String   @default("üèüÔ∏è")
  color           String   @default("#FF6B35")

  // Aggregate stats (denormalized)
  memberCount     Int      @default(0)
  totalPoints     Int      @default(0)
  totalCheckins   Int      @default(0)
  totalEvents     Int      @default(0)

  // Settings
  isPublic        Boolean  @default(true)
  maxMembers      Int      @default(50)

  members         CrewMember[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([schoolId])
  @@index([totalPoints])
}

model CrewMember {
  id          String   @id @default(cuid())
  crewId      String
  userId      String
  crew        Crew      @relation(fields: [crewId], references: [id], onDelete: Cascade)
  user        RallyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  role        CrewRole  @default(MEMBER)
  joinedAt    DateTime  @default(now())

  @@unique([crewId, userId])
  @@index([crewId])
  @@index([userId])
}

enum CrewRole {
  CAPTAIN     // creator / admin
  LIEUTENANT  // co-admin
  MEMBER
}

// ==========================================
// SOCIAL IDENTITY ‚Äî Milestones & Badges
// ==========================================

model FanMilestone {
  id          String   @id @default(cuid())
  userId      String
  user        RallyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        MilestoneType
  title       String              // "First Check-in", "10-Game Streak", "Prediction King"
  description String?
  icon        String              // emoji or icon key
  sport       String?             // null = global milestone

  // For shareable cards
  stat        String?             // "10 games", "85% accuracy", etc.
  earnedAt    DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([earnedAt])
}

enum MilestoneType {
  FIRST_CHECKIN
  CHECKIN_STREAK_5
  CHECKIN_STREAK_10
  CHECKIN_STREAK_25
  CHECKIN_STREAK_50
  EVENTS_5
  EVENTS_25
  EVENTS_50
  EVENTS_100
  EVENTS_250
  PREDICTION_ACCURACY_75
  PREDICTION_ACCURACY_90
  TRIVIA_MASTER
  ALL_ACTIVATIONS        // completed every activation at an event
  MULTI_SPORT            // attended events in 3+ sports
  TIER_SILVER
  TIER_GOLD
  TIER_PLATINUM
  CREW_FOUNDER
  VENUE_COLLECTOR_5      // visited 5 unique venues
  VENUE_COLLECTOR_10
  VENUE_COLLECTOR_25
  SUPERFAN_VERIFIED
  LEGEND_VERIFIED
}

// ==========================================
// SOCIAL IDENTITY ‚Äî Shareable Cards
// ==========================================

model ShareCard {
  id          String   @id @default(cuid())
  userId      String
  user        RallyUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        ShareCardType
  title       String              // "Season Recap", "Head-to-Head Result"
  data        Json                // Flexible payload for card rendering

  // Tracking
  viewCount   Int      @default(0)
  shareCount  Int      @default(0)

  createdAt   DateTime @default(now())
  expiresAt   DateTime?           // optional expiry for event-specific cards

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

enum ShareCardType {
  MILESTONE           // badge / achievement earned
  HEAD_TO_HEAD        // fan comparison result
  SEASON_RECAP        // end-of-season stats
  EVENT_RECAP         // single event summary
  STREAK              // streak achievement
  TIER_UP             // tier promotion
  CREW_LEADERBOARD    // crew ranking
  FAN_RESUME          // full fan identity card
}
